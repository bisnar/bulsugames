<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wordshake - Student Vocabulary Game</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
      * {
        box-sizing: border-box;
        font-family: "Comic Sans MS", "Segoe UI", Tahoma, Geneva, Verdana,
          sans-serif;
      }

      body {
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        color: #fff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        overflow-x: hidden;
      }

      /* Animated background stars */
      .stars {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
      }

      .star {
        position: absolute;
        background-color: white;
        border-radius: 50%;
        animation: twinkle 3s infinite;
      }

      @keyframes twinkle {
        0%,
        100% {
          opacity: 0.3;
        }
        50% {
          opacity: 1;
        }
      }

      .container {
        max-width: 850px;
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(12px);
        border-radius: 25px;
        padding: 30px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        margin-top: 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
      }

      .container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 8px;
        background: linear-gradient(
          90deg,
          #ff6b6b,
          #4ecdc4,
          #45b7d1,
          #96ceb4,
          #feca57,
          #ff9ff3
        );
        border-radius: 25px 25px 0 0;
      }

      h1 {
        text-align: center;
        margin-top: 0;
        color: #ffcc00;
        text-shadow: 0 2px 10px rgba(255, 204, 0, 0.7),
          0 0 20px rgba(255, 255, 255, 0.5);
        font-size: 3.2rem;
        margin-bottom: 10px;
        letter-spacing: 2px;
        background: linear-gradient(to right, #ffcc00, #ff9900, #ffcc00);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: title-glow 2s infinite alternate;
      }

      @keyframes title-glow {
        from {
          text-shadow: 0 2px 10px rgba(255, 204, 0, 0.7),
            0 0 20px rgba(255, 255, 255, 0.5);
        }
        to {
          text-shadow: 0 2px 15px rgba(255, 204, 0, 0.9),
            0 0 30px rgba(255, 255, 255, 0.7);
        }
      }

      /* Player Name Display */
      .player-info {
        text-align: center;
        margin-bottom: 15px;
        font-size: 1.3rem;
        background: linear-gradient(90deg, #4ecdc4, #45b7d1);
        padding: 12px 25px;
        border-radius: 50px;
        display: inline-block;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .player-name {
        color: #fff;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      .game-description {
        text-align: center;
        margin-bottom: 25px;
        line-height: 1.5;
        background: rgba(0, 0, 0, 0.25);
        padding: 20px;
        border-radius: 15px;
        border-left: 5px solid #4ecdc4;
      }

      .difficulty-selector {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }

      .difficulty-btn {
        padding: 15px 30px;
        font-size: 1.2rem;
        font-weight: bold;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        color: white;
        min-width: 160px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
      }

      .difficulty-btn::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.7s;
      }

      .difficulty-btn:hover::after {
        left: 100%;
      }

      .difficulty-btn:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      }

      .difficulty-btn.active {
        transform: scale(1.05);
      }

      .easy-btn {
        background: linear-gradient(145deg, #4caf50, #2e7d32);
        border: 2px solid #81c784;
      }

      .easy-btn.active {
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
      }

      .medium-btn {
        background: linear-gradient(145deg, #ff9800, #ef6c00);
        border: 2px solid #ffb74d;
      }

      .medium-btn.active {
        box-shadow: 0 0 20px rgba(255, 152, 0, 0.8);
      }

      .hard-btn {
        background: linear-gradient(145deg, #f44336, #c62828);
        border: 2px solid #e57373;
      }

      .hard-btn.active {
        box-shadow: 0 0 20px rgba(244, 67, 54, 0.8);
      }

      .start-button-container {
        text-align: center;
        margin-bottom: 25px;
        display: none;
      }

      .start-btn {
        padding: 18px 50px;
        font-size: 1.5rem;
        font-weight: bold;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        background: linear-gradient(145deg, #ff6b6b, #ff4757);
        color: white;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
        letter-spacing: 1px;
      }

      .start-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.7s;
      }

      .start-btn:hover::before {
        left: 100%;
      }

      .start-btn:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        background: linear-gradient(145deg, #ff5252, #ff3838);
      }

      .game-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 25px;
        background: rgba(0, 0, 0, 0.3);
        padding: 20px;
        border-radius: 15px;
        border: 2px solid rgba(255, 255, 255, 0.1);
      }

      .timer-container,
      .score-container {
        text-align: center;
        padding: 10px 20px;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.2);
        min-width: 150px;
      }

      .timer {
        font-size: 2.8rem;
        font-weight: bold;
        color: #4ecdc4;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        font-family: "Courier New", monospace;
        letter-spacing: 2px;
      }

      .score {
        font-size: 2.8rem;
        font-weight: bold;
        color: #ffcc00;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        font-family: "Courier New", monospace;
      }

      .score-label,
      .timer-label {
        font-size: 1.1rem;
        color: #ccc;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .letters-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
        margin: 30px 0;
        justify-items: center;
        background: rgba(0, 0, 0, 0.2);
        padding: 25px;
        border-radius: 20px;
        border: 2px solid rgba(255, 255, 255, 0.1);
      }

      .letter {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: bold;
        background: linear-gradient(145deg, #ffcc00, #ff9900);
        color: #1a2a6c;
        border-radius: 15px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        user-select: none;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
      }

      .letter::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: rgba(255, 255, 255, 0.1);
        transform: rotate(45deg);
        transition: all 0.5s;
        opacity: 0;
      }

      .letter:hover::after {
        opacity: 1;
        transform: rotate(45deg) translate(20%, 20%);
      }

      .letter:hover {
        transform: scale(1.15) rotate(5deg);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      }

      .letter.selected {
        background: linear-gradient(145deg, #00cc66, #00aa44);
        color: white;
        transform: scale(1.15);
        box-shadow: 0 0 20px rgba(0, 204, 102, 0.7);
      }

      .input-area {
        margin: 25px 0;
        text-align: center;
      }

      .word-input {
        width: 100%;
        padding: 22px;
        font-size: 1.8rem;
        text-align: center;
        border: 3px solid #4ecdc4;
        border-radius: 15px;
        background-color: rgba(255, 255, 255, 0.95);
        color: #333;
        margin-bottom: 20px;
        letter-spacing: 3px;
        font-weight: bold;
        transition: all 0.3s;
      }

      .word-input:focus {
        outline: none;
        box-shadow: 0 0 0 4px rgba(78, 205, 196, 0.5);
        border-color: #ffcc00;
        transform: scale(1.02);
      }

      .game-controls {
        display: flex;
        justify-content: center;
        gap: 25px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }

      .control-btn {
        padding: 18px 35px;
        font-size: 1.2rem;
        font-weight: bold;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s;
        min-width: 160px;
        box-shadow: 0 7px 15px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
      }

      .control-btn::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.7s;
      }

      .control-btn:hover::after {
        left: 100%;
      }

      .control-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
      }

      .new-game-btn {
        background: linear-gradient(145deg, #4caf50, #2e7d32);
        color: white;
      }

      .cancel-btn {
        background: linear-gradient(145deg, #ff9800, #ef6c00);
        color: white;
      }

      .enter-btn {
        background: linear-gradient(145deg, #2196f3, #0d47a1);
        color: white;
      }

      .found-words {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        padding: 25px;
        margin-top: 25px;
        max-height: 220px;
        overflow-y: auto;
        border: 2px solid rgba(255, 255, 255, 0.1);
      }

      .found-words h3 {
        margin-top: 0;
        color: #ffcc00;
        font-size: 1.5rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 10px;
        margin-bottom: 15px;
      }

      .words-list {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .word-item {
        background: linear-gradient(145deg, #6a11cb, #2575fc);
        padding: 10px 18px;
        border-radius: 25px;
        font-size: 1.2rem;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.5s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .word-item span {
        color: #ffcc00;
        margin-left: 8px;
        font-weight: bold;
      }

      .home-btn {
        display: block;
        margin: 30px auto 10px;
        padding: 15px 35px;
        background: linear-gradient(145deg, #6a11cb, #2575fc);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }

      .home-btn::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.7s;
      }

      .home-btn:hover::after {
        left: 100%;
      }

      .home-btn:hover {
        background: linear-gradient(145deg, #2575fc, #6a11cb);
        transform: translateY(-5px);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
      }

      .game-over {
        text-align: center;
        padding: 40px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 20px;
        margin-top: 20px;
        display: none;
        border: 3px solid rgba(255, 255, 255, 0.2);
        animation: fadeIn 0.8s;
      }

      .game-over h2 {
        color: #ffcc00;
        font-size: 2.8rem;
        margin-bottom: 20px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      }

      .final-score {
        font-size: 3.5rem;
        color: #ffcc00;
        font-weight: bold;
        margin: 20px 0;
        text-shadow: 0 2px 15px rgba(255, 204, 0, 0.7);
        background: linear-gradient(to right, #ffcc00, #ff9900, #ffcc00);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .final-message {
        font-size: 1.6rem;
        margin: 20px 0;
        min-height: 40px;
        color: #aaddff;
        padding: 15px;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.2);
      }

      .rules {
        background: rgba(0, 0, 0, 0.25);
        padding: 20px;
        border-radius: 15px;
        margin-top: 25px;
        font-size: 1rem;
        line-height: 1.5;
        border-left: 5px solid #ffcc00;
      }

      .validation-info {
        margin-top: 10px;
        padding: 12px;
        background: rgba(78, 205, 196, 0.2);
        border-radius: 10px;
        font-size: 0.9rem;
        color: #aaddff;
        text-align: center;
        border: 1px solid rgba(78, 205, 196, 0.3);
      }

      .level-timer-info {
        margin-top: 5px;
        padding: 10px;
        background: rgba(76, 175, 80, 0.2);
        border-radius: 10px;
        font-size: 0.9rem;
        color: #90ee90;
        text-align: center;
        border: 1px solid rgba(76, 175, 80, 0.3);
      }

      .level-warning {
        margin-top: 10px;
        padding: 10px;
        background: rgba(255, 152, 0, 0.2);
        border-radius: 10px;
        font-size: 0.9rem;
        color: #ffcc80;
        text-align: center;
        border: 1px solid rgba(255, 152, 0, 0.3);
      }

      .error-message {
        margin: 15px auto;
        padding: 15px 25px;
        background: linear-gradient(145deg, #f44336, #c62828);
        color: white;
        border-radius: 10px;
        font-size: 1.1rem;
        text-align: center;
        max-width: 600px;
        display: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .success-message {
        margin: 15px auto;
        padding: 15px 25px;
        background: linear-gradient(145deg, #4caf50, #2e7d32);
        color: white;
        border-radius: 10px;
        font-size: 1.1rem;
        text-align: center;
        max-width: 600px;
        display: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .game-area {
        display: none;
      }

      .game-intro {
        text-align: center;
        padding: 35px;
        background: rgba(0, 0, 0, 0.25);
        border-radius: 20px;
        margin: 20px 0;
        border: 2px solid rgba(255, 255, 255, 0.1);
      }

      .game-intro h3 {
        color: #ffcc00;
        margin-bottom: 20px;
        font-size: 1.8rem;
      }

      .game-intro p {
        margin: 10px 0;
        padding: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
      }

      .ready-to-play {
        font-size: 1.4rem;
        color: #ffcc00;
        margin: 20px 0;
        text-align: center;
        font-weight: bold;
        padding: 15px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        border: 2px dashed rgba(255, 204, 0, 0.5);
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }
        h1 {
          font-size: 2.5rem;
        }
        .letters-grid {
          gap: 12px;
        }
        .letter {
          width: 65px;
          height: 65px;
          font-size: 2rem;
        }
        .game-controls {
          flex-direction: column;
          align-items: center;
        }
        .control-btn {
          width: 100%;
          max-width: 300px;
        }
        .difficulty-btn {
          min-width: 140px;
          padding: 12px 20px;
          font-size: 1.1rem;
        }
        .start-btn {
          padding: 15px 35px;
          font-size: 1.3rem;
        }
        .timer,
        .score {
          font-size: 2.2rem;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 15px;
        }
        h1 {
          font-size: 2rem;
        }
        .letter {
          width: 55px;
          height: 55px;
          font-size: 1.7rem;
        }
        .difficulty-selector {
          flex-direction: column;
          align-items: center;
        }
        .difficulty-btn {
          width: 100%;
          max-width: 250px;
        }
        .game-info {
          flex-direction: column;
          gap: 15px;
        }
        .timer-container,
        .score-container {
          min-width: auto;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Particle animation for celebration */
      .particle {
        position: fixed;
        pointer-events: none;
        z-index: 2;
        animation: particle-float 3s ease-out forwards;
      }

      @keyframes particle-float {
        0% {
          transform: translateY(0) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(-100px) rotate(180deg);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="stars" id="starsContainer"></div>

    <h1>WORDSHAKE</h1>

    <div class="player-info" id="playerInfo">
      Player: <span class="player-name" id="playerNameDisplay">Guest</span>
    </div>

    <div class="container">
      <div class="game-description">
        <p>
          Create as many words as possible from the 4x4 letter grid within 3
          minutes. Words must be 3-7 letters long. Each letter can only be used
          once per word.
        </p>
        <div class="validation-info" id="validationInfo">
          Loading comprehensive English word dictionary...
        </div>
        <div class="level-timer-info" id="levelTimerInfo">
          Each difficulty level is a separate 3-minute game!
        </div>
        <div class="level-warning" id="levelWarning">
          Select a difficulty level, then click START to begin!
        </div>
      </div>

      <div class="difficulty-selector">
        <button class="difficulty-btn easy-btn active" data-level="easy">
          Easy (3:00)
        </button>
        <button class="difficulty-btn medium-btn" data-level="medium">
          Medium (3:00)
        </button>
        <button class="difficulty-btn hard-btn" data-level="hard">
          Hard (3:00)
        </button>
      </div>

      <div class="start-button-container" id="startButtonContainer">
        <button class="start-btn" id="startBtn">START GAME</button>
      </div>

      <div class="ready-to-play" id="readyToPlay">
        Ready to play <span id="selectedLevel">Easy</span> level? Click START
        above!
      </div>

      <div class="game-intro" id="gameIntro">
        <h3>How to Play</h3>
        <p>1. Select a difficulty level (Easy, Medium, or Hard)</p>
        <p>2. Click the START GAME button</p>
        <p>
          3. You'll have 3 minutes to find as many words as possible from the
          letter grid
        </p>
        <p>4. Click letters or type to form words (3-7 letters long)</p>
        <p>
          5. All common English words are accepted including verbs like "had",
          "has", "have"
        </p>
      </div>

      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <div class="game-area" id="gameArea">
        <div class="game-info">
          <div class="timer-container">
            <div class="timer-label">TIME REMAINING</div>
            <div class="timer">03:00</div>
          </div>

          <div class="score-container">
            <div class="score-label">SCORE</div>
            <div class="score">0</div>
          </div>
        </div>

        <div class="letters-grid" id="lettersGrid"></div>

        <div class="input-area">
          <input
            type="text"
            class="word-input"
            id="wordInput"
            placeholder="Click letters or type to form a word"
            maxlength="7"
          />

          <div class="game-controls">
            <button class="control-btn new-game-btn" id="newGameBtn">
              New Game
            </button>
            <button class="control-btn cancel-btn" id="cancelBtn">
              Cancel
            </button>
            <button class="control-btn enter-btn" id="enterBtn">
              Enter Word
            </button>
          </div>
        </div>

        <div class="found-words">
          <h3>Found Words: <span id="wordsCount">0</span></h3>
          <div class="words-list" id="wordsList"></div>
        </div>
      </div>

      <div class="rules">
        <p>
          <strong>Scoring:</strong> 3 letters = 1 point, 4 letters = 2 points, 5
          letters = 3 points, 6 letters = 4 points, 7 letters = 5 points
        </p>
        <p>
          <strong>Note:</strong> Words must be valid English words between 3-7
          letters. All common English words are accepted.
        </p>
      </div>

      <div class="game-over" id="gameOver">
        <h2>Time's Up!</h2>
        <div class="final-score" id="finalScore">0</div>
        <div class="final-message" id="finalMessage"></div>
        <button class="control-btn new-game-btn" id="playAgainBtn">
          Play Again
        </button>
      </div>
    </div>

    <button class="home-btn" id="homeBtn">Back to home</button>

    <script>
      // ==========================================
      // 2. CONFIGURATION & REALTIME DATABASE SETUP
      // ==========================================
      const firebaseConfig = {
    apiKey: "AIzaSyAmFvD90ym0_3MyWd3FOM-6DUtcs1ZLYsY",
    authDomain: "bulsugame.firebaseapp.com",
    databaseURL: "https://bulsugame-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bulsugame",
    storageBucket: "bulsugame.firebasestorage.app",
    messagingSenderId: "965621798926",
    appId: "1:965621798926:web:e76b5359c45b39904ec45f",
    measurementId: "G-VJ4LKZ8615",
  };

      // Initialize Firebase
      let db;
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    console.log("Firebase Realtime Database connected!");
  } catch (error) {
    console.error("Firebase connection error:", error);
  }

      // ==========================================
      // GAME LOGIC
      // ==========================================

      let gameActive = false;
      let timeLeft = 180; // 3 minutes in seconds
      let score = 0;
      let foundWords = [];
      let selectedLetters = [];
      let timerInterval = null;
      let currentDifficulty = "easy";
      let wordDictionary = new Set();
      let dictionaryLoaded = false;
      let currentLetters = [];
      let timerHasStarted = false;
      let playerName = "Guest";

      const levelGameStates = {
        easy: {
          score: 0,
          foundWords: [],
          timeLeft: 180,
          gameActive: false,
          letters: [],
          selectedLetters: [],
          timerHasStarted: false,
        },
        medium: {
          score: 0,
          foundWords: [],
          timeLeft: 180,
          gameActive: false,
          letters: [],
          selectedLetters: [],
          timerHasStarted: false,
        },
        hard: {
          score: 0,
          foundWords: [],
          timeLeft: 180,
          gameActive: false,
          letters: [],
          selectedLetters: [],
          timerHasStarted: false,
        },
      };

      const levelTimers = { easy: 180, medium: 180, hard: 180 };

      // Letter sets including "B" in easy to allow "beat"
      const letterSets = {
        easy: [
          ["A", "E", "I", "O", "U", "R", "S", "T", "B"], // Added B
          ["A", "E", "I", "O", "U", "N", "L", "D", "T"], // Added T
          ["A", "E", "I", "O", "U", "C", "M", "P"],
          ["A", "E", "I", "O", "U", "H", "G", "B"],
        ],
        medium: [
          ["A", "E", "I", "O", "R", "S", "T", "N"],
          ["A", "E", "I", "O", "L", "D", "C", "M"],
          ["A", "E", "I", "O", "U", "P", "H", "G"],
          ["A", "E", "I", "O", "U", "B", "F", "Y"],
        ],
        hard: [
          ["A", "E", "I", "R", "S", "T", "N", "L"],
          ["A", "E", "O", "D", "C", "M", "P", "H"],
          ["A", "I", "O", "U", "G", "B", "F", "Y"],
          ["E", "I", "O", "U", "W", "K", "V", "J"],
        ],
      };

      // Complete Dictionary with common words including "beat"
      const englishWordDictionary = [
        "beat",
        "bear",
        "bean",
        "beak",
        "bell",
        "belt",
        "best",
        "bent",
        "back",
        "ball",
        "bank",
        "base",
        "bath",
        "bead",
        "beam",
        "beef",
        "beer",
        "beet",
        "begs",
        "bend",
        "bias",
        "bide",
        "bike",
        "bill",
        "bind",
        "bird",
        "bite",
        "bits",
        "blew",
        "blue",
        "blur",
        "boat",
        "body",
        "boil",
        "bold",
        "bolt",
        "bond",
        "bone",
        "book",
        "boom",
        "boot",
        "bore",
        "born",
        "boss",
        "both",
        "bowl",
        "boys",
        "brad",
        "brag",
        "bran",
        "bray",
        "bred",
        "brew",
        "brim",
        "brow",
        "buck",
        "buds",
        "buff",
        "bugs",
        "bulb",
        "bulk",
        "bull",
        "bump",
        "buns",
        "bunt",
        "burn",
        "bury",
        "bush",
        "buss",
        "bust",
        "busy",
        "buts",
        "butt",
        "buys",
        "buzz",
        "bye",
        "able",
        "acid",
        "aged",
        "also",
        "area",
        "army",
        "away",
        "baby",
        "bake",
        "ball",
        "band",
        "bank",
        "base",
        "bath",
        "beak",
        "beam",
        "bean",
        "bear",
        "beat",
        "beef",
        "beer",
        "bell",
        "belt",
        "bend",
        "bent",
        "best",
        "bias",
        "bide",
        "bike",
        "bill",
        "bind",
        "bird",
        "bite",
        "blue",
        "boat",
        "body",
        "boil",
        "bold",
        "bond",
        "bone",
        "book",
        "boom",
        "boot",
        "bore",
        "born",
        "boss",
        "both",
        "bowl",
        "bulk",
        "burn",
        "bury",
        "bush",
        "busy",
        "cage",
        "cake",
        "call",
        "calm",
        "came",
        "camp",
        "card",
        "care",
        "case",
        "cash",
        "cast",
        "cats",
        "cave",
        "cell",
        "cent",
        "chat",
        "chef",
        "chew",
        "chin",
        "chip",
        "chop",
        "city",
        "clap",
        "claw",
        "clay",
        "clip",
        "club",
        "clue",
        "coal",
        "coat",
        "code",
        "coil",
        "coin",
        "cold",
        "comb",
        "come",
        "cook",
        "cool",
        "cope",
        "copy",
        "cord",
        "core",
        "cork",
        "corn",
        "cost",
        "crew",
        "crop",
        "crow",
        "cube",
        "cure",
        "curl",
        "cute",
        "damp",
        "dare",
        "dark",
        "dart",
        "dash",
        "date",
        "dawn",
        "days",
        "dead",
        "deaf",
        "deal",
        "dear",
        "debt",
        "deck",
        "deed",
        "deep",
        "deer",
        "deny",
        "desk",
        "dial",
        "dice",
        "diet",
        "dine",
        "dirt",
        "dish",
        "dive",
        "dock",
        "does",
        "dogs",
        "doll",
        "dome",
        "done",
        "door",
        "dose",
        "down",
        "drag",
        "draw",
        "drop",
        "drug",
        "drum",
        "duck",
        "duel",
        "dull",
        "dump",
        "dune",
        "dung",
        "dusk",
        "dust",
        "duty",
        "each",
        "earn",
        "ease",
        "east",
        "easy",
        "edge",
        "edit",
        "eggs",
        "else",
        "ends",
        "envy",
        "epic",
        "even",
        "ever",
        "evil",
        "exam",
        "exit",
        "face",
        "fact",
        "fade",
        "fail",
        "fair",
        "fall",
        "fame",
        "farm",
        "fast",
        "fate",
        "fear",
        "feat",
        "feed",
        "feel",
        "fees",
        "feet",
        "fell",
        "felt",
        "file",
        "fill",
        "film",
        "find",
        "fine",
        "fire",
        "firm",
        "fish",
        "fist",
        "five",
        "flag",
        "flat",
        "fled",
        "flee",
        "flew",
        "flip",
        "flow",
        "foam",
        "foil",
        "fold",
        "folk",
        "fond",
        "food",
        "fool",
        "foot",
        "ford",
        "fork",
        "form",
        "fort",
        "foul",
        "four",
        "free",
        "frog",
        "from",
        "fuel",
        "full",
        "fume",
        "fund",
        "fury",
        "fuse",
        "fuss",
        "gain",
        "gait",
        "gala",
        "game",
        "gang",
        "gaps",
        "gasp",
        "gate",
        "gave",
        "gear",
        "gems",
        "gene",
        "gent",
        "germ",
        "gets",
        "gift",
        "girl",
        "give",
        "glad",
        "glee",
        "glow",
        "glue",
        "goal",
        "goat",
        "goes",
        "gold",
        "golf",
        "gone",
        "good",
        "gown",
        "grab",
        "gray",
        "grew",
        "grey",
        "grid",
        "grim",
        "grin",
        "grip",
        "grit",
        "grow",
        "gulf",
        "gums",
        "guns",
        "gust",
        "hail",
        "hair",
        "hale",
        "half",
        "hall",
        "halt",
        "hand",
        "hang",
        "hard",
        "harm",
        "harp",
        "hate",
        "hats",
        "haul",
        "have",
        "hawk",
        "haze",
        "head",
        "heal",
        "heap",
        "hear",
        "heat",
        "heel",
        "heir",
        "held",
        "hell",
        "help",
        "herb",
        "herd",
        "here",
        "hero",
        "hers",
        "hide",
        "high",
        "hike",
        "hill",
        "hint",
        "hire",
        "hiss",
        "hive",
        "hold",
        "hole",
        "home",
        "hood",
        "hook",
        "hoop",
        "hope",
        "horn",
        "hose",
        "host",
        "hour",
        "huge",
        "hull",
        "hump",
        "hung",
        "hunt",
        "hurt",
        "hush",
        "huts",
        "icon",
        "idea",
        "idle",
        "idol",
        "inch",
        "into",
        "iron",
        "itch",
        "item",
        "jail",
        "jars",
        "jazz",
        "jeep",
        "jets",
        "join",
        "joke",
        "jolt",
        "jump",
        "jury",
        "just",
        "keen",
        "keep",
        "kept",
        "keys",
        "kick",
        "kids",
        "kill",
        "kind",
        "king",
        "kiss",
        "kite",
        "knee",
        "knew",
        "knit",
        "knot",
        "know",
        "labs",
        "lack",
        "lady",
        "laid",
        "lake",
        "lamb",
        "lamp",
        "land",
        "lane",
        "last",
        "late",
        "lava",
        "lawn",
        "laws",
        "lead",
        "leaf",
        "leak",
        "lean",
        "leap",
        "left",
        "legs",
        "lend",
        "lens",
        "lent",
        "less",
        "lest",
        "lets",
        "liar",
        "lice",
        "lick",
        "lids",
        "lied",
        "lies",
        "life",
        "lift",
        "like",
        "limb",
        "lime",
        "limp",
        "line",
        "link",
        "lion",
        "lips",
        "list",
        "live",
        "load",
        "loaf",
        "loan",
        "lock",
        "loft",
        "logs",
        "lone",
        "long",
        "look",
        "loop",
        "loose",
        "loss",
        "lost",
        "lots",
        "loud",
        "love",
        "lows",
        "luck",
        "lump",
        "lung",
        "lure",
        "lush",
        "lust",
        "maid",
        "mail",
        "main",
        "make",
        "male",
        "mall",
        "many",
        "maps",
        "mark",
        "mars",
        "mash",
        "mask",
        "mass",
        "mast",
        "mate",
        "math",
        "mats",
        "meal",
        "mean",
        "meat",
        "meet",
        "melt",
        "menu",
        "mess",
        "mice",
        "mild",
        "mile",
        "milk",
        "mill",
        "mind",
        "mine",
        "mint",
        "miss",
        "mist",
        "mode",
        "mold",
        "mole",
        "mood",
        "moon",
        "more",
        "moss",
        "most",
        "moth",
        "move",
        "much",
        "muddy",
        "mugs",
        "mule",
        "muse",
        "must",
        "mute",
        "myth",
        "nail",
        "name",
        "navy",
        "near",
        "neat",
        "neck",
        "need",
        "nest",
        "nets",
        "news",
        "next",
        "nice",
        "nine",
        "node",
        "noise",
        "none",
        "noon",
        "norm",
        "nose",
        "note",
        "noun",
        "null",
        "nuts",
        "oaks",
        "oars",
        "oath",
        "ocean",
        "odds",
        "odor",
        "okay",
        "once",
        "only",
        "onto",
        "open",
        "oral",
        "oven",
        "over",
        "owls",
        "owns",
        "pace",
        "pack",
        "pact",
        "page",
        "paid",
        "pain",
        "pair",
        "pale",
        "palm",
        "pans",
        "pant",
        "park",
        "part",
        "pass",
        "past",
        "path",
        "pats",
        "pave",
        "pawn",
        "peak",
        "pear",
        "peas",
        "peel",
        "peep",
        "peer",
        "pets",
        "pick",
        "pile",
        "pill",
        "pine",
        "pink",
        "pins",
        "pint",
        "pipe",
        "pits",
        "plan",
        "play",
        "plea",
        "plot",
        "plug",
        "plum",
        "plus",
        "poem",
        "poet",
        "pole",
        "poll",
        "pond",
        "pool",
        "poor",
        "pope",
        "pork",
        "port",
        "pose",
        "post",
        "pots",
        "pour",
        "pray",
        "prep",
        "prey",
        "pull",
        "pulp",
        "pump",
        "pure",
        "push",
        "quit",
        "quiz",
        "race",
        "rack",
        "raft",
        "rage",
        "raid",
        "rail",
        "rain",
        "rake",
        "ramp",
        "rank",
        "rare",
        "rash",
        "rate",
        "rats",
        "rave",
        "rays",
        "read",
        "real",
        "rear",
        "rely",
        "rent",
        "rest",
        "rice",
        "rich",
        "ride",
        "ring",
        "ripe",
        "rise",
        "risk",
        "road",
        "roar",
        "robe",
        "rock",
        "rode",
        "role",
        "roll",
        "roof",
        "room",
        "root",
        "rope",
        "rose",
        "rows",
        "rube",
        "ruby",
        "rude",
        "ruin",
        "rule",
        "runs",
        "rush",
        "rust",
        "sack",
        "safe",
        "saga",
        "said",
        "sail",
        "sale",
        "salt",
        "same",
        "sand",
        "sang",
        "sank",
        "save",
        "scan",
        "scar",
        "seal",
        "seat",
        "seed",
        "seek",
        "seem",
        "seen",
        "sees",
        "self",
        "sell",
        "send",
        "sent",
        "sets",
        "sewn",
        "shed",
        "ship",
        "shoe",
        "shop",
        "shot",
        "show",
        "shut",
        "sick",
        "side",
        "sift",
        "sign",
        "silk",
        "salo",
        "sing",
        "sink",
        "site",
        "size",
        "skin",
        "skip",
        "skis",
        "slam",
        "slap",
        "sled",
        "slip",
        "slot",
        "slow",
        "slum",
        "snap",
        "snow",
        "soak",
        "soap",
        "soar",
        "sock",
        "soda",
        "sofa",
        "soft",
        "soil",
        "sold",
        "sole",
        "solo",
        "some",
        "song",
        "soon",
        "sore",
        "sort",
        "soul",
        "soup",
        "sour",
        "span",
        "spin",
        "spit",
        "spot",
        "spun",
        "spur",
        "stab",
        "stag",
        "star",
        "stay",
        "stem",
        "step",
        "stew",
        "stir",
        "stop",
        "stow",
        "stud",
        "stun",
        "such",
        "suck",
        "suit",
        "sung",
        "sunk",
        "sure",
        "surf",
        "swan",
        "swap",
        "swat",
        "sway",
        "swim",
        "tabs",
        "tack",
        "tact",
        "tail",
        "take",
        "tale",
        "talk",
        "tall",
        "tank",
        "tape",
        "task",
        "taxi",
        "team",
        "tear",
        "tech",
        "tell",
        "tend",
        "tent",
        "term",
        "test",
        "text",
        "than",
        "that",
        "them",
        "then",
        "they",
        "thin",
        "this",
        "thou",
        "thus",
        "tick",
        "tide",
        "tidy",
        "tied",
        "ties",
        "tile",
        "till",
        "time",
        "tiny",
        "tips",
        "tire",
        "toad",
        "toes",
        "toil",
        "told",
        "toll",
        "tone",
        "tons",
        "took",
        "tool",
        "tops",
        "tore",
        "torn",
        "toss",
        "tour",
        "town",
        "toys",
        "trap",
        "tray",
        "tree",
        "trek",
        "trim",
        "trip",
        "trot",
        "true",
        "tube",
        "tuck",
        "tuna",
        "tune",
        "turf",
        "turn",
        "tusk",
        "twin",
        "type",
        "ugly",
        "undo",
        "unit",
        "unto",
        "upon",
        "urge",
        "used",
        "user",
        "uses",
        "vain",
        "vale",
        "vary",
        "vase",
        "vast",
        "veal",
        "veil",
        "vein",
        "vent",
        "very",
        "vest",
        "veto",
        "vice",
        "view",
        "vine",
        "visa",
        "void",
        "volt",
        "vote",
        "wade",
        "wage",
        "wait",
        "wake",
        "walk",
        "wall",
        "wand",
        "want",
        "ward",
        "warm",
        "warn",
        "warp",
        "wars",
        "wash",
        "wasp",
        "watt",
        "wave",
        "wavy",
        "ways",
        "weak",
        "wear",
        "webs",
        "weed",
        "week",
        "weep",
        "well",
        "went",
        "wept",
        "were",
        "west",
        "what",
        "when",
        "whip",
        "whom",
        "wide",
        "wife",
        "wild",
        "will",
        "wind",
        "wine",
        "wing",
        "wink",
        "wins",
        "wipe",
        "wire",
        "wise",
        "wish",
        "with",
        "wolf",
        "wood",
        "wool",
        "word",
        "work",
        "worm",
        "worn",
        "wrap",
        "yard",
        "yarn",
        "year",
        "yell",
        "yoga",
        "yolk",
        "zero",
        "zinc",
        "zone",
        "zoom",
        "school",
        "pencil",
        "friend",
        "library",
        "science",
        "history",
        "equation",
        "geometry",
        "experiment",
        "photosynthesis",
      ];

      // DOM elements
      const lettersGrid = document.getElementById("lettersGrid");
      const wordInput = document.getElementById("wordInput");
      const timerElement = document.querySelector(".timer");
      const scoreElement = document.querySelector(".score");
      const wordsCountElement = document.getElementById("wordsCount");
      const wordsListElement = document.getElementById("wordsList");
      const gameOverElement = document.getElementById("gameOver");
      const finalScoreElement = document.getElementById("finalScore");
      const finalMessageElement = document.getElementById("finalMessage");
      const validationInfoElement = document.getElementById("validationInfo");
      const levelTimerInfoElement = document.getElementById("levelTimerInfo");
      const levelWarningElement = document.getElementById("levelWarning");
      const errorMessageElement = document.getElementById("errorMessage");
      const successMessageElement = document.getElementById("successMessage");
      const gameAreaElement = document.getElementById("gameArea");
      const gameIntroElement = document.getElementById("gameIntro");
      const startButtonContainer = document.getElementById(
        "startButtonContainer"
      );
      const startBtn = document.getElementById("startBtn");
      const readyToPlayElement = document.getElementById("readyToPlay");
      const selectedLevelElement = document.getElementById("selectedLevel");
      const playerNameDisplay = document.getElementById("playerNameDisplay");
      const playerInfo = document.getElementById("playerInfo");
      const starsContainer = document.getElementById("starsContainer");

      const newGameBtn = document.getElementById("newGameBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const enterBtn = document.getElementById("enterBtn");
      const playAgainBtn = document.getElementById("playAgainBtn");
      const homeBtn = document.getElementById("homeBtn");
      const difficultyButtons = document.querySelectorAll(".difficulty-btn");

      function createStars() {
        for (let i = 0; i < 100; i++) {
          const star = document.createElement("div");
          star.classList.add("star");
          const size = Math.random() * 3 + 1;
          star.style.width = `${size}px`;
          star.style.height = `${size}px`;
          star.style.left = `${Math.random() * 100}%`;
          star.style.top = `${Math.random() * 100}%`;
          star.style.animationDelay = `${Math.random() * 3}s`;
          starsContainer.appendChild(star);
        }
      }

      function createParticles(count, x, y, color) {
        for (let i = 0; i < count; i++) {
          const particle = document.createElement("div");
          particle.classList.add("particle");
          const size = Math.random() * 10 + 5;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          particle.style.backgroundColor = color || getRandomColor();
          particle.style.left = `${x}px`;
          particle.style.top = `${y}px`;
          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 100 + 50;
          const vx = Math.cos(angle) * speed;
          const vy = Math.sin(angle) * speed;
          particle.animate(
            [
              { transform: `translate(0, 0) rotate(0deg)`, opacity: 1 },
              {
                transform: `translate(${vx}px, ${vy}px) rotate(180deg)`,
                opacity: 0,
              },
            ],
            {
              duration: 1500,
              easing: "cubic-bezier(0.215, 0.610, 0.355, 1)",
            }
          );
          document.body.appendChild(particle);
          setTimeout(() => {
            if (particle.parentNode) particle.parentNode.removeChild(particle);
          }, 1500);
        }
      }

      function getRandomColor() {
        const colors = [
          "#ff6b6b",
          "#4ecdc4",
          "#45b7d1",
          "#96ceb4",
          "#feca57",
          "#ff9ff3",
          "#ffcc00",
        ];
        return colors[Math.floor(Math.random() * colors.length)];
      }

      async function loadWordDictionary() {
        try {
          englishWordDictionary.forEach((word) => {
            if (word.length >= 3 && word.length <= 7) {
              wordDictionary.add(word.toLowerCase());
            }
          });
          dictionaryLoaded = true;
          validationInfoElement.textContent =
            "Comprehensive English dictionary loaded! Includes animals, foods, places, and things!";
        } catch (error) {
          console.error("Error loading dictionary:", error);
          validationInfoElement.textContent =
            "Using comprehensive English word list. Includes animals, foods, places, and things!";
        }
      }

      function loadPlayerName() {
        const urlParams = new URLSearchParams(window.location.search);
        const playerNameParam = urlParams.get("player");

        if (playerNameParam && playerNameParam.trim() !== "") {
          playerName = playerNameParam;
        }

        playerNameDisplay.textContent = playerName;
        const description = document.querySelector(".game-description p");
        if (description) {
          description.innerHTML = `Welcome <span class="player-name">${playerName}</span>! Create as many words as possible from the 4x4 letter grid within 3 minutes. Words must be 3-7 letters long. Each letter can only be used once per word.`;
        }
      }

      // ==========================================
      // NEW: SAVE TO FIREBASE FUNCTION
      // ==========================================
      function saveScoreToFirebase() {
        if (!db) {
          console.error("Database not initialized");
          return;
        }

        const scoreData = {
          playerName: playerName,
          score: score,
          gameName: "Word Shake",
          date: new Date().toLocaleDateString(),
          timestamp: Date.now(),
        };

        db.ref("scores")
          .push(scoreData)
          .then(() => {
            console.log("Score saved to Firebase!");
            // alert(`Score saved to Global Leaderboard!`);
          })
          .catch((error) => {
            console.error("Error saving score: ", error);
          });
      }

      function showErrorMessage(message) {
        errorMessageElement.textContent = message;
        errorMessageElement.style.display = "block";
        successMessageElement.style.display = "none";
        setTimeout(() => {
          errorMessageElement.style.display = "none";
        }, 3000);
      }

      function showSuccessMessage(message) {
        successMessageElement.textContent = message;
        successMessageElement.style.display = "block";
        errorMessageElement.style.display = "none";
        const rect = successMessageElement.getBoundingClientRect();
        createParticles(
          20,
          rect.left + rect.width / 2,
          rect.top + rect.height / 2,
          "#4CAF50"
        );
        setTimeout(() => {
          successMessageElement.style.display = "none";
        }, 2000);
      }

      function saveCurrentGameState() {
        levelGameStates[currentDifficulty] = {
          score: score,
          foundWords: [...foundWords],
          timeLeft: timeLeft,
          gameActive: gameActive,
          letters: [...currentLetters],
          selectedLetters: [...selectedLetters],
          timerHasStarted: timerHasStarted,
        };
      }

      function loadGameState(level) {
        const state = levelGameStates[level];
        score = state.score;
        foundWords = [...state.foundWords];
        timeLeft = state.timeLeft;
        gameActive = state.gameActive;
        timerHasStarted = state.timerHasStarted;
        currentLetters = [...state.letters];
        selectedLetters = [...state.selectedLetters];
        updateScore();
        updateWordsList();
        updateTimer();
        if (currentLetters.length === 16) {
          renderLetters(currentLetters);
        } else {
          generateLettersForLevel(level);
        }
        updateSelectedLettersVisual();
        wordInput.value = "";
        if (!gameActive && timeLeft <= 0) {
          showGameOver();
        } else {
          gameOverElement.style.display = "none";
        }
      }

      function renderLetters(letters) {
        lettersGrid.innerHTML = "";
        for (let i = 0; i < 16; i++) {
          const letter = document.createElement("div");
          letter.className = "letter";
          letter.textContent = letters[i];
          letter.dataset.index = i;
          letter.addEventListener("click", () => selectLetter(i, letters[i]));
          lettersGrid.appendChild(letter);
        }
      }

      function updateSelectedLettersVisual() {
        document.querySelectorAll(".letter").forEach((letter) => {
          letter.classList.remove("selected");
        });
        selectedLetters.forEach((index) => {
          const letterElement = document.querySelector(
            `.letter[data-index="${index}"]`
          );
          if (letterElement) letterElement.classList.add("selected");
        });
      }

      function generateLettersForLevel(level) {
        const letterSetsForDifficulty = letterSets[level];
        const randomSetIndex = Math.floor(
          Math.random() * letterSetsForDifficulty.length
        );
        const letterSet = [...letterSetsForDifficulty[randomSetIndex]];
        const vowels = ["A", "E", "I", "O", "U"];
        const commonConsonants = [
          "R",
          "S",
          "T",
          "N",
          "L",
          "D",
          "C",
          "M",
          "P",
          "H",
          "G",
          "B",
          "F",
          "Y",
          "W",
          "K",
          "V",
          "J",
          "X",
          "Q",
          "Z",
        ];
        while (letterSet.length < 16) {
          if (Math.random() > 0.4) {
            letterSet.push(vowels[Math.floor(Math.random() * vowels.length)]);
          } else {
            letterSet.push(
              commonConsonants[
                Math.floor(Math.random() * commonConsonants.length)
              ]
            );
          }
        }
        for (let i = letterSet.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [letterSet[i], letterSet[j]] = [letterSet[j], letterSet[i]];
        }
        currentLetters = letterSet;
        levelGameStates[level].letters = [...letterSet];
        renderLetters(letterSet);
      }

      function canFormWord(word) {
        const availableLetters = currentLetters.map((l) => l.toLowerCase());
        const lettersCopy = [...availableLetters];
        const wordLetters = word.toLowerCase().split("");
        for (const letter of wordLetters) {
          const index = lettersCopy.indexOf(letter);
          if (index === -1) return false;
          lettersCopy.splice(index, 1);
        }
        return true;
      }

      function getEndGameMessage(score) {
        if (score === 0) return "Game over, your score: 0";
        return `Congratulations! You have a score: ${score}.`;
      }

      function startGameForLevel() {
        gameIntroElement.style.display = "none";
        gameAreaElement.style.display = "block";
        startButtonContainer.style.display = "none";
        readyToPlayElement.style.display = "none";
        errorMessageElement.style.display = "none";
        successMessageElement.style.display = "none";
        if (
          levelGameStates[currentDifficulty].gameActive &&
          levelGameStates[currentDifficulty].timeLeft > 0 &&
          levelGameStates[currentDifficulty].timerHasStarted
        ) {
          if (
            confirm(
              `Continue your existing ${currentDifficulty} game? Click OK to continue or Cancel to start fresh.`
            )
          ) {
            loadGameState(currentDifficulty);
            if (gameActive && timerHasStarted) {
              if (timerInterval) clearInterval(timerInterval);
              startTimer();
            }
            levelWarningElement.textContent = `Continuing ${currentDifficulty} level game.`;
            return;
          }
        }
        initFreshGameForLevel(currentDifficulty);
        levelWarningElement.textContent = `Click ENTER WORD or select letters to begin playing!`;
      }

      function initFreshGameForLevel(level) {
        if (gameActive && timerInterval) {
          clearInterval(timerInterval);
          saveCurrentGameState();
        }
        gameActive = true;
        timeLeft = levelTimers[level];
        score = 0;
        foundWords = [];
        selectedLetters = [];
        timerHasStarted = false;
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        updateTimer();
        updateScore();
        updateWordsList();
        generateLettersForLevel(level);
        gameOverElement.style.display = "none";
        wordInput.focus();
        saveCurrentGameState();
        if (dictionaryLoaded) {
          levelTimerInfoElement.textContent = `${level.toUpperCase()} level: Ready to start 3-minute game!`;
          levelWarningElement.textContent = `Timer will start when you enter your first word or click a letter.`;
        }
      }

      function startTimer() {
        if (!timerHasStarted) {
          timerHasStarted = true;
          levelGameStates[currentDifficulty].timerHasStarted = true;
          levelWarningElement.textContent = `Timer started! 3 minutes remaining...`;
        }
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          timeLeft--;
          updateTimer();
          levelGameStates[currentDifficulty].timeLeft = timeLeft;
          if (timeLeft <= 0) endGame();
        }, 1000);
      }

      function selectLetter(index, letter) {
        if (!gameActive) return;
        if (!timerHasStarted) startTimer();
        const letterElement = document.querySelector(
          `.letter[data-index="${index}"]`
        );
        if (selectedLetters.includes(index)) {
          selectedLetters = selectedLetters.filter((i) => i !== index);
          letterElement.classList.remove("selected");
        } else if (selectedLetters.length < 7) {
          selectedLetters.push(index);
          letterElement.classList.add("selected");
        }
        levelGameStates[currentDifficulty].selectedLetters = [
          ...selectedLetters,
        ];
        updateWordInput();
      }

      function updateWordInput() {
        let word = "";
        for (const index of selectedLetters) {
          const letterElement = document.querySelector(
            `.letter[data-index="${index}"]`
          );
          word += letterElement.textContent;
        }
        wordInput.value = word;
      }

      function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `${minutes
          .toString()
          .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        if (timeLeft <= 30) {
          timerElement.style.color = "#ff4444";
          timerElement.style.animation = "none";
          setTimeout(() => {
            timerElement.style.animation = "pulse 0.5s infinite alternate";
          }, 10);
        } else if (timeLeft <= 60) {
          timerElement.style.color = "#ffaa00";
        } else {
          timerElement.style.color = "#4ecdc4";
        }
      }

      function updateScore() {
        scoreElement.textContent = score;
        scoreElement.style.transform = "scale(1.1)";
        setTimeout(() => {
          scoreElement.style.transform = "scale(1)";
        }, 200);
      }

      function updateWordsList() {
        wordsCountElement.textContent = foundWords.length;
        wordsListElement.innerHTML = "";
        foundWords.forEach((word) => {
          const wordItem = document.createElement("div");
          wordItem.className = "word-item";
          const points = calculatePoints(word);
          wordItem.innerHTML = `${word.toUpperCase()} <span>+${points}</span>`;
          wordsListElement.appendChild(wordItem);
        });
        wordsListElement.scrollTop = wordsListElement.scrollHeight;
      }

      function calculatePoints(word) {
        const length = word.length;
        if (length === 3) return 1;
        if (length === 4) return 2;
        if (length === 5) return 3;
        if (length === 6) return 4;
        if (length === 7) return 5;
        return 0;
      }

      function isValidWord(word) {
        if (word.length < 3 || word.length > 7)
          return {
            valid: false,
            message: `Word must be 3-7 letters long. "${word.toUpperCase()}" is ${
              word.length
            } letters.`,
          };
        if (foundWords.includes(word.toLowerCase()))
          return {
            valid: false,
            message: `"${word.toUpperCase()}" has already been used.`,
          };
        if (!canFormWord(word))
          return {
            valid: false,
            message: `"${word.toUpperCase()}" cannot be formed from the available letters.`,
          };
        if (!wordDictionary.has(word.toLowerCase()))
          return {
            valid: false,
            message: `"${word.toUpperCase()}" is not a common English word. Try another word!`,
          };
        return {
          valid: true,
          message: `"${word.toUpperCase()}" accepted! +${calculatePoints(
            word
          )} points!`,
        };
      }

      function submitWord() {
        if (!gameActive) return;
        if (!timerHasStarted) startTimer();
        const word = wordInput.value.trim().toLowerCase();
        if (word.length === 0) {
          showErrorMessage("Please enter a word!");
          return;
        }
        const validation = isValidWord(word);
        if (!validation.valid) {
          showErrorMessage(validation.message);
          clearSelection();
          return;
        }
        foundWords.push(word);
        score += calculatePoints(word);
        updateScore();
        updateWordsList();
        levelGameStates[currentDifficulty].score = score;
        levelGameStates[currentDifficulty].foundWords = [...foundWords];
        showSuccessMessage(validation.message);
        clearSelection();
      }

      function clearSelection() {
        selectedLetters.forEach((index) => {
          const letterElement = document.querySelector(
            `.letter[data-index="${index}"]`
          );
          if (letterElement) letterElement.classList.remove("selected");
        });
        selectedLetters = [];
        levelGameStates[currentDifficulty].selectedLetters = [];
        wordInput.value = "";
        wordInput.focus();
      }

      function showGameOver() {
        createParticles(50, window.innerWidth / 2, 100, "#ffcc00");
        finalScoreElement.textContent = score;
        finalMessageElement.textContent = getEndGameMessage(score);
        gameOverElement.style.display = "block";
        gameOverElement.scrollIntoView({ behavior: "smooth" });
      }

      function endGame() {
        gameActive = false;
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        levelGameStates[currentDifficulty].gameActive = false;
        levelGameStates[currentDifficulty].timeLeft = 0;

        // SAVE TO FIREBASE
        saveScoreToFirebase();

        showGameOver();
      }

      function setDifficulty(level) {
        currentDifficulty = level;
        difficultyButtons.forEach((btn) => {
          if (btn.dataset.level === level) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
        selectedLevelElement.textContent =
          level.charAt(0).toUpperCase() + level.slice(1);
        startButtonContainer.style.display = "block";
        readyToPlayElement.style.display = "block";
        gameAreaElement.style.display = "none";
        gameIntroElement.style.display = "block";
        levelTimerInfoElement.textContent = `${level.toUpperCase()} level selected: 3-minute game`;
        levelWarningElement.textContent = `Click START GAME to begin the ${level} level challenge!`;
        errorMessageElement.style.display = "none";
        successMessageElement.style.display = "none";
      }

      startBtn.addEventListener("click", startGameForLevel);
      newGameBtn.addEventListener("click", () => {
        if (confirm("Start a new game? Your current progress will be lost.")) {
          initFreshGameForLevel(currentDifficulty);
          timerHasStarted = false;
          levelWarningElement.textContent = `Timer will start when you enter your first word or click a letter.`;
        }
      });
      cancelBtn.addEventListener("click", clearSelection);
      enterBtn.addEventListener("click", submitWord);
      playAgainBtn.addEventListener("click", () => {
        initFreshGameForLevel(currentDifficulty);
        timerHasStarted = false;
        levelWarningElement.textContent = `Timer will start when you enter your first word or click a letter.`;
      });
      homeBtn.addEventListener("click", () => {
        window.location.href = "index.html";
      });
      difficultyButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          setDifficulty(btn.dataset.level);
        });
      });
      wordInput.addEventListener("input", () => {
        selectedLetters.forEach((index) => {
          const letterElement = document.querySelector(
            `.letter[data-index="${index}"]`
          );
          if (letterElement) letterElement.classList.remove("selected");
        });
        selectedLetters = [];
        levelGameStates[currentDifficulty].selectedLetters = [];
        wordInput.value = wordInput.value.toUpperCase();
      });
      wordInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") submitWord();
      });

      window.addEventListener("DOMContentLoaded", async () => {
        createStars();
        loadPlayerName();
        await loadWordDictionary();
        Object.keys(levelGameStates).forEach((level) => {
          levelGameStates[level] = {
            score: 0,
            foundWords: [],
            timeLeft: levelTimers[level],
            gameActive: false,
            letters: [],
            selectedLetters: [],
            timerHasStarted: false,
          };
        });
        gameIntroElement.style.display = "block";
        gameAreaElement.style.display = "none";
        startButtonContainer.style.display = "none";
        readyToPlayElement.style.display = "block";
        setDifficulty("easy");
      });
    </script>
  </body>
</html>